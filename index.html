<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algo Special | Cotizador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#FF1F9F',
                        'secondary': '#C1FF00',
                        'accent': '#FF9D00',
                        'text-dark': '#000000',
                        'text-light': '#FFFFFF',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #FF9D00 0%, #FFB033 100%);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 10px;
        }
        .card {
            position: relative;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border: 2px solid #000000;
        }
        input[type="number"], select, textarea {
            transition: all 0.2s;
            border-color: #000000;
            font-size: 16px; /* Previene zoom en iOS */
        }
        input:focus, select:focus, textarea:focus {
            border-color: #FF1F9F !important;
            box-shadow: 0 0 0 3px rgba(255, 31, 159, 0.5) !important;
        }
        .add-to-list-button {
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.3s;
        }
        .add-to-list-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(255, 31, 159, 0.5);
        }
        .add-to-list-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(255, 31, 159, 0.3);
        }
        @keyframes pulse-secondary {
            0%, 100% { background-color: #C1FF00; }
            50% { background-color: #A3D900; }
        }
        .pulse-secondary-animation {
            animation: pulse-secondary 1.5s infinite;
        }
        .ticket {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            margin: 15px auto;
            font-family: 'Inter', sans-serif;
        }
        .ticket-header {
            text-align: center;
            border-bottom: 2px dashed #FF1F9F;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .ticket-logo {
            height: 50px;
            margin: 0 auto 8px;
        }
        .ticket-title {
            font-size: 16px;
            font-weight: 800;
            color: #FF1F9F;
            margin-bottom: 3px;
        }
        .ticket-subtitle {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        .ticket-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .ticket-total {
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            font-size: 16px;
            padding: 12px 0;
            border-top: 2px dashed #FF1F9F;
            margin-top: 8px;
        }
        .ticket-footer {
            text-align: center;
            font-size: 11px;
            color: #888;
            margin-top: 12px;
        }
        
        /* Mejoras específicas para móviles */
        @media (max-width: 640px) {
            body {
                padding: 5px;
                align-items: flex-start;
            }
            .card {
                padding: 0.75rem;
                margin: 5px 0;
            }
            .grid-cols-2 {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            .ticket {
                width: 100%;
                padding: 12px;
            }
            .text-2xl {
                font-size: 1.4rem;
            }
            .text-3xl {
                font-size: 1.6rem;
            }
            .text-4xl {
                font-size: 1.8rem;
            }
            .text-lg {
                font-size: 1rem;
            }
            .text-xl {
                font-size: 1.2rem;
            }
            .p-8 {
                padding: 1rem;
            }
            .p-5 {
                padding: 0.75rem;
            }
            .space-y-6 {
                gap: 1rem;
            }
            .py-4 {
                padding-top: 0.75rem;
                padding-bottom: 0.75rem;
            }
            .py-3 {
                padding-top: 0.6rem;
                padding-bottom: 0.6rem;
            }
            .mb-8 {
                margin-bottom: 1.5rem;
            }
            .mt-8 {
                margin-top: 1.5rem;
            }
            .mt-6 {
                margin-top: 1.2rem;
            }
            .text-base {
                font-size: 0.9rem;
            }
            .text-sm {
                font-size: 0.8rem;
            }
            .text-xs {
                font-size: 0.75rem;
            }
            .h-40 {
                height: 7rem;
            }
            .sm\:h-52 {
                height: 9rem;
            }
        }
        
        /* Ajustes para pantallas muy pequeñas */
        @media (max-width: 380px) {
            .card {
                padding: 0.5rem;
            }
            .text-2xl {
                font-size: 1.3rem;
            }
            .text-3xl {
                font-size: 1.5rem;
            }
            .text-4xl {
                font-size: 1.6rem;
            }
            .p-5 {
                padding: 0.6rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="card bg-text-light w-full max-w-2xl p-4 sm:p-6 md:p-8 rounded-2xl">
        <!-- Logo -->
        <div class="mb-0 flex justify-center">
            <img src="https://www.dropbox.com/scl/fi/xpobzj48hrvwrggk9w2iz/INSTAGRAM.png?rlkey=zcxxkd3uuj27nlbsiccynl6ju&st=cj2dj0xl&dl=1" 
                 alt="Logo de Algo Special" 
                 class="h-32 sm:h-40 md:h-52 w-auto object-contain">
        </div>
        
        <!-- Título y Subtítulo -->
        <p class="text-center text-base sm:text-lg text-text-dark/80 mb-1 italic font-semibold leading-tight">Transforma cada momento en una experiencia extraordinaria</p>
        <p class="text-center text-xl sm:text-2xl font-extrabold text-primary mb-4 sm:mb-6 md:mb-8">COTIZA TU PEDIDO</p>

        <!-- Formulario de Entrada -->
        <div class="space-y-4 sm:space-y-6">
            <!-- Producto -->
            <div>
                <div class="pt-3 sm:pt-4 px-4 sm:px-5 pb-1 sm:pb-2 bg-secondary rounded-xl border-2 border-text-dark shadow-lg mb-1 sm:mb-2">
                    <label for="material" class="block text-base sm:text-lg font-extrabold text-text-dark uppercase">ELIGE PRODUCTO</label>
                </div>
                
                <select id="material" onchange="calculateQuote()"
                        class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-sm sm:text-base">
                    <!-- PRODUCTOS STICKERS -->
                    <option value="premium_dtf" selected>STICKER PREMIUM (DTF UV)</option>
                    <option value="classic_glossy">STICKER CLÁSICO (ADHESIVO FOTOGLOSSY)</option>
                    <option value="vinyl_white">STICKER VINIL IMPRESO (BLANCO)</option>
                    <option value="vinyl_clear">STICKER VINIL IMPRESO (TRANSPARENTE)</option>

                    <!-- PRODUCTOS FIJOS SEPARADOS -->
                    <option value="vaso">VASO PERSONALIZADO</option>
                    <option value="mantelito">MANTELITO Ó SOBREPLATO</option>
                    <option value="combo">COMBO (VASO + MANTELITO/SOBREPLATO)</option>
                </select>
            </div>
            
            <!-- INTERFAZ 1 - CÁLCULO DTF POR LARGO -->
            <div id="dtf-interface">
                 <!-- Contenedor para CALCULAR CENTÍMETROS NECESARIOS -->
                <div id="dtf-calculator" class="space-y-3 sm:space-y-4 pt-3 sm:pt-4 p-4 sm:p-5 bg-secondary rounded-xl border-2 border-text-dark shadow-lg mb-1 sm:mb-2">
                    <p class="text-base sm:text-lg font-extrabold text-text-dark uppercase leading-tight">CALCULADORA DE LARGO (DTF UV)</p>
                    <p class="text-xs sm:text-sm text-text-dark/70 font-bold mb-2 sm:mb-4 leading-tight">Calcula el largo total que necesitas según la cantidad y tamaño de tus diseños.</p>
                    
                    <!-- Cantidad -->
                    <div>
                        <label for="quantity_dtf" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">Cantidad de Stickers</label>
                        <input type="number" id="quantity_dtf" value="100" min="1" oninput="calculateQuote()"
                               class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base">
                    </div>

                    <!-- Tamaño (Ancho y Alto) -->
                    <div class="grid grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label for="width_dtf" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">Ancho (cm)</label>
                            <input type="number" id="width_dtf" value="5" min="0.1" step="0.1" oninput="calculateQuote()"
                                   class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base">
                        </div>
                        <div>
                            <label for="height_dtf" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">Alto (cm)</label>
                            <input type="number" id="height_dtf" value="5" min="0.1" step="0.1" oninput="calculateQuote()"
                                   class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base">
                        </div>
                    </div>
                    
                    <!-- Resultado del Cálculo de Largo -->
                    <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-text-dark/30">
                        <p class="flex justify-between items-center">
                            <span class="text-sm sm:text-base font-extrabold text-text-dark">Centímetros Sugeridos:</span>
                            <span id="calculated_length" class="font-extrabold text-primary text-xl sm:text-2xl">0 CM</span>
                        </p>
                    </div>
                </div>
                <!-- Contenedor para cotización por LARGO (DTF UV - PRECIO) -->
                <div id="length-inputs" class="space-y-3 sm:space-y-4 pt-3 sm:pt-4 p-4 sm:p-5 bg-secondary rounded-xl border-2 border-text-dark shadow-lg mt-4 sm:mt-6">
                    <p class="text-base sm:text-lg font-extrabold text-text-dark uppercase leading-tight">PRECIO FINAL POR LARGO</p>
                    
                    <!-- Largo Total -->
                    <div class="mt-3 sm:mt-4 space-y-2">
                        <label for="printed_length_direct" class="block text-sm sm:text-base font-bold text-text-dark mb-1">Largo Final a Cotizar (cm)</label>
                        <input type="number" id="printed_length_direct" value="380" min="0" step="1" oninput="calculateDtfPrice()"
                               class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base">
                        
                        <!-- Sección de Resultados DTF (Unificado) -->
                        <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-text-dark/30">
                            <!-- Fila 1: TOTAL EN PESOS -->
                            <div class="flex justify-between items-center bg-text-light p-2 sm:p-3 rounded-lg border-2 border-text-dark shadow-md">
                                <span class="text-sm sm:text-base font-extrabold text-text-dark">TOTAL EN PESOS:</span>
                                <span id="dtf-total-price" class="text-xl sm:text-2xl md:text-3xl font-extrabold text-primary">$0</span>
                            </div>
                            
                            <!-- Fila 2: Costo por Centímetro (Efectivo) -->
                            <div class="flex justify-between text-xs sm:text-sm mt-2">
                                <span class="text-text-dark/80 font-medium">COSTO POR CENTÍMETRO (Efectivo):</span> 
                                <span id="dtf-unit-price" class="font-bold text-text-dark">$0.00 MXN</span>
                            </div>
                        </div>
                        <!-- Botón para Agregar a la Lista -->
                        <button id="add-to-list-dtf" onclick="addCurrentQuoteToList()" disabled 
                                class="add-to-list-button mt-3 sm:mt-4 w-full py-2 sm:py-3 font-extrabold text-text-light bg-primary rounded-lg border-2 border-text-dark shadow-xl disabled:bg-gray-300 disabled:text-gray-500 disabled:border-gray-500 text-sm sm:text-base">
                            AÑADIR A LA LISTA
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- INTERFAZ 2 - CÁLCULO POR ÁREA/PLANILLAS (Stickers Clásicos/Vinil) -->
            <div id="area-inputs" class="space-y-4 sm:space-y-6 hidden">
                <div class="space-y-3 sm:space-y-4 pt-3 sm:pt-4 p-4 sm:p-5 bg-secondary rounded-xl border-2 border-text-dark shadow-lg">
                    <p class="text-base sm:text-lg font-extrabold text-text-dark uppercase leading-tight">INGRESO DE CANTIDAD Y TAMAÑO</p>
                    
                    <!-- Cantidad -->
                    <div>
                        <label for="quantity" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">Cantidad de Stickers</label>
                        <input type="number" id="quantity" value="100" min="1" oninput="calculateAreaPrice()"
                               class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base">
                        <p class="text-xs text-text-dark/70 mt-1">La planilla es tamaño Oficio (18x26 cm útil).</p>
                    </div>

                    <!-- Tamaño (Ancho y Alto) -->
                    <div class="grid grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <label for="width" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">Ancho (cm)</label>
                            <input type="number" id="width" value="5" min="1" step="0.1" oninput="calculateAreaPrice()"
                                   class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base">
                        </div>
                        <div>
                            <label for="height" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">Alto (cm)</label>
                            <input type="number" id="height" value="5" min="1" step="0.1" oninput="calculateAreaPrice()"
                                   class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base">
                        </div>
                    </div>
                    
                    <!-- NUEVO: Opciones de planillas prediseñadas -->
                    <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-text-dark/30">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="predefined-sheet" onchange="togglePredefinedSheets()" class="mr-2">
                            <label for="predefined-sheet" class="text-sm sm:text-base font-semibold text-text-dark">Planilla Prediseñada</label>
                        </div>
                        
                        <div id="predefined-sheets-container" class="hidden mt-2">
                            <select id="predefined-sheets" onchange="applyPredefinedSheet()" class="w-full rounded-lg border-2 border-text-dark shadow-md p-2 bg-text-light text-sm">
                                <option value="">Selecciona una plantilla</option>
                                <option value="3x3">3x3 cm (35 stickers)</option>
                                <option value="4x4">4x4 cm (24 stickers)</option>
                                <option value="4.5x4.5">4.5x4.5 cm (20 stickers)</option>
                                <option value="5x5">5x5 cm (12 stickers)</option>
                                <option value="5.5x5.5">5.5x5.5 cm (12 stickers)</option>
                                <option value="6x6">6x6 cm (12 stickers)</option>
                                <option value="7x7">7x7 cm (9 stickers)</option>
                                <option value="8x8">8x8 cm (6 stickers)</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center mt-3">
                            <input type="checkbox" id="full-range" onchange="toggleFullRange()" class="mr-2">
                            <label for="full-range" class="text-sm sm:text-base font-semibold text-text-dark">Rango Completo</label>
                        </div>
                        
                        <div id="full-range-container" class="hidden mt-2">
                            <select id="paper-size" onchange="calculateFullRange()" class="w-full rounded-lg border-2 border-text-dark shadow-md p-2 bg-text-light text-sm">
                                <option value="carta">Carta (21.59 x 27.94 cm)</option>
                                <option value="a4">A4 (21 x 29.7 cm)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Detalle de Planillas y Resultados -->
                <div class="space-y-2 pt-3 sm:pt-4 p-4 sm:p-5 bg-secondary rounded-xl border-2 border-text-dark shadow-lg">
                    <p class="text-base sm:text-lg font-extrabold text-text-dark uppercase leading-tight">DETALLE DE PRODUCCIÓN</p>
                    <div id="cricut-details" class="text-sm sm:text-base text-text-dark">
                        <p class="flex justify-between border-b border-text-dark/20 pb-1">
                            <span>Stickers por Planilla:</span>
                            <span id="fit-per-sheet" class="font-bold text-text-dark">0</span>
                        </p>
                        <p class="flex justify-between pt-1">
                            <span>Planillas necesarias:</span>
                            <span id="sheets-needed" class="font-bold text-primary text-lg sm:text-xl">0</span>
                        </p>
                        
                        <!-- NUEVO: Campo para ingresar manualmente las planillas -->
                        <div class="mt-3 pt-3 border-t border-text-dark/20">
                            <label for="manual-sheets" class="block text-sm font-semibold text-text-dark mb-1">Planillas Requeridas (ingreso manual):</label>
                            <input type="number" id="manual-sheets" min="0" step="1" oninput="calculateManualSheets()"
                                   class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 bg-text-light text-sm">
                        </div>
                    </div>
                    <p class="text-xs text-text-dark/70 pt-1 font-bold text-primary">Pedido menores a 5 planillas no incluyen diseño.</p>

                    <!-- Sección de Resultados Área (Unificado) -->
                    <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-text-dark/30">
                         <!-- Fila 1: TOTAL EN PESOS (Planilla) -->
                        <div class="flex justify-between items-center bg-text-light p-2 sm:p-3 rounded-lg border-2 border-text-dark shadow-md">
                            <span class="text-sm sm:text-base font-extrabold text-text-dark">TOTAL EN PESOS:</span>
                            <span id="area-total-price" class="text-xl sm:text-2xl md:text-3xl font-extrabold text-primary">$0</span>
                        </div>
                        
                        <!-- Fila 2: Costo por Planilla -->
                        <div class="flex justify-between text-xs sm:text-sm mt-2">
                            <span class="text-text-dark/80 font-medium">COSTO POR PLANILLA:</span> 
                            <span id="area-unit-price" class="font-bold text-text-dark">$0.00 MXN</span>
                        </div>
                    </div>
                    
                    <!-- Botón para Agregar a la Lista -->
                    <button id="add-to-list-area" onclick="addCurrentQuoteToList()" disabled 
                            class="add-to-list-button mt-3 sm:mt-4 w-full py-2 sm:py-3 font-extrabold text-text-light bg-primary rounded-lg border-2 border-text-dark shadow-xl disabled:bg-gray-300 disabled:text-gray-500 disabled:border-gray-500 text-sm sm:text-base">
                        AÑADIR A LA LISTA
                    </button>
                </div>
            </div>
            
            <!-- INTERFAZ 3 - PRODUCTOS DE PRECIO FIJO -->
            <div id="product-inputs" class="space-y-4 sm:space-y-6 hidden">
                <!-- Contenedor Único para Vasos/Productos Fijos -->
                <div class="space-y-3 sm:space-y-4 pt-3 sm:pt-4 p-4 sm:p-5 bg-secondary rounded-xl border-2 border-text-dark shadow-lg">
                    
                    <!-- Select para Tipo de Vaso (Solo si es Vaso/Combo) -->
                    <div id="vaso-type-container" class="hidden space-y-2">
                         <label for="select-vaso" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">TIPO DE VASO</label>
                        <select id="select-vaso" onchange="calculateFixedPrice()"
                                class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-sm sm:text-base">
                            <!-- Opciones se llenan dinámicamente -->
                        </select>
                    </div>

                    <!-- Select para Tipo de Mantelito (Solo si es Mantelito) -->
                    <div id="mantelito-type-container" class="hidden space-y-2">
                        <label for="select-mantelito" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">TIPO DE MANTELITO/SOBREPLATO</label>
                        <select id="select-mantelito" onchange="calculateFixedPrice()"
                                class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-sm sm:text-base">
                            <!-- TIPOS DE MANTELITO/SOBREPLATO -->
                            <option value="carta">MANTELITO CARTA</option>
                            <option value="redondo">SOBREPLATO REDONDO</option>
                            <option value="silueta">SOBREPLATO SILUETA</option>
                            <option value="media_carta">SOBREPLATO MEDIA CARTA</option>
                        </select>
                    </div>

                    <!-- Cantidad -->
                    <div>
                        <label for="quantity_product" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">CANTIDAD DE UNIDADES</label>
                        <input type="number" id="quantity_product" value="10" min="1" placeholder="Ej: 50" oninput="calculateFixedPrice()"
                               class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base">
                    </div>

                    <!-- NUEVO: Campo para Detalles de Personalización -->
                    <div id="personalization-container" class="hidden space-y-2">
                        <label for="personalization_details" class="block text-sm sm:text-base font-semibold text-text-dark mb-1">DETALLES DE PERSONALIZACIÓN</label>
                        <textarea id="personalization_details" 
                                  placeholder="Ej: Logo de empresa, nombre del evento, diseño específico, etc."
                                  oninput="calculateFixedPrice()"
                                  class="mt-1 block w-full rounded-lg border-2 border-text-dark shadow-md p-2 sm:p-3 bg-text-light focus:ring-primary focus:border-primary text-text-dark text-sm sm:text-base resize-none"
                                  rows="3"></textarea>
                        <p class="text-xs text-text-dark/70">Describe los detalles de la personalización que necesitas</p>
                    </div>

                    <!-- Resultado de Productos Fijos (Total en Pesos / Costo por Unidad) -->
                    <div class="space-y-2 pt-3 sm:pt-4 border-t border-text-dark/30">
                        <!-- Fila 1: TOTAL EN PESOS -->
                        <div class="flex justify-between items-center bg-text-light p-2 sm:p-3 rounded-lg border-2 border-text-dark shadow-md">
                            <span class="text-sm sm:text-base font-extrabold text-text-dark">TOTAL EN PESOS:</span>
                            <span id="product-total-price" class="text-xl sm:text-2xl md:text-3xl font-extrabold text-primary">$0</span>
                        </div>
                        
                        <!-- Fila 2: Costo por Unidad -->
                        <div class="flex justify-between text-xs sm:text-sm mt-2">
                            <span class="text-text-dark/80 font-medium">COSTO POR UNIDAD:</span> 
                            <span id="product-unit-price" class="font-bold text-text-dark">$0.00 MXN</span>
                        </div>
                    </div>
                    
                    <!-- Botón para Agregar a la Lista -->
                    <button id="add-to-list-product" onclick="addCurrentQuoteToList()" disabled 
                            class="add-to-list-button mt-3 sm:mt-4 w-full py-2 sm:py-3 font-extrabold text-text-light bg-primary rounded-lg border-2 border-text-dark shadow-xl disabled:bg-gray-300 disabled:text-gray-500 disabled:border-gray-500 text-sm sm:text-base">
                        AÑADIR A LA LISTA
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Productos y Total -->
        <div class="mt-6 sm:mt-8 pt-4 sm:pt-6 border-t-2 border-text-dark">
            <h2 class="text-lg sm:text-xl font-extrabold text-text-dark mb-3 sm:mb-4">TU LISTA DE PRODUCTOS</h2>
            
            <!-- Contenedor de la lista -->
            <div id="quote-list" class="space-y-2 sm:space-y-3 p-3 sm:p-4 bg-gray-50 rounded-xl border-2 border-gray-300 min-h-[50px]">
                <p id="empty-list-message" class="text-center text-gray-500 italic text-sm sm:text-base">La lista está vacía.</p>
            </div>
            
            <!-- Total a Pagar -->
            <div class="mt-3 sm:mt-4 flex justify-between items-center bg-text-dark text-text-light p-3 sm:p-4 md:p-5 rounded-xl border-2 border-primary shadow-lg">
                <span class="text-lg sm:text-xl md:text-2xl font-extrabold">TOTAL A PAGAR:</span>
                <span id="final-total" class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-extrabold text-secondary">$0</span>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="mt-4 sm:mt-6 flex flex-col gap-3 sm:gap-4 w-full justify-center">
            <button id="generate-ticket-btn" onclick="generateTicket()" disabled
                    class="flex items-center justify-center w-full py-3 sm:py-4 text-base sm:text-lg md:text-xl font-extrabold text-text-light bg-accent rounded-lg border-2 border-text-dark shadow-xl hover:bg-accent/80 focus:outline-none focus:ring-4 focus:ring-accent/50 disabled:bg-gray-300 disabled:text-gray-500 disabled:border-gray-500">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                <span>DESCARGAR COTIZACIÓN</span>
            </button>
            
            <a id="order-button" 
               href="#" 
               target="_blank" 
               class="flex items-center justify-center w-full py-3 sm:py-4 text-base sm:text-lg md:text-xl font-extrabold text-text-light bg-primary rounded-lg border-2 border-text-dark shadow-xl hover:bg-primary/80 focus:outline-none focus:ring-4 focus:ring-primary/50">
                <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <span>CONFIRMAR PEDIDO</span>
            </a>
        </div>
        
        <!-- Ticket oculto para generar imagen -->
        <div id="ticket-container" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-4 sm:p-6 rounded-xl max-w-md w-full mx-3 sm:mx-4">
                <div class="flex justify-between items-center mb-3 sm:mb-4">
                    <h3 class="text-lg sm:text-xl font-bold text-text-dark">Vista Previa del Ticket</h3>
                    <button onclick="closeTicketPreview()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="ticket-preview" class="ticket mb-3 sm:mb-4">
                    <!-- El contenido del ticket se genera aquí -->
                </div>
                <div class="flex justify-between">
                    <button onclick="closeTicketPreview()" class="px-3 sm:px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 text-sm sm:text-base">Cancelar</button>
                    <button onclick="downloadTicket()" class="px-3 sm:px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/80 text-sm sm:text-base">Descargar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONSTANTES Y VARIABLES GLOBALES
        const MIN_DTF_LENGTH = 10;
        let quoteList = [];

        // CONSTANTES DE PRECIOS
        const CLASSIC_GLOSSY_PRICING_MAP = {
            1: 25, 2: 50, 3: 75, 4: 100, 
            5: 90, 6: 108, 7: 126, 8: 144, 9: 162, 10: 180, 11: 198, 12: 216, 13: 234, 14: 252, 15: 270, 16: 288, 17: 306, 18: 324, 19: 335, 20: 340,
            21: 357, 22: 374, 23: 391, 24: 408, 25: 425, 26: 442, 27: 459, 28: 476, 29: 493, 30: 510,
            31: 527, 32: 544, 33: 561, 34: 578, 35: 595, 36: 612, 37: 629, 38: 646, 39: 663, 40: 680,
            41: 697, 42: 714, 43: 720, 44: 720, 45: 720, 46: 736, 47: 740, 48: 745, 49: 745, 50: 750,
            51: 765, 52: 780, 53: 795, 54: 810, 55: 825, 56: 840, 57: 855, 58: 870, 59: 885, 60: 900,
            61: 915, 62: 930, 63: 945, 64: 960, 65: 975, 66: 990, 67: 1005, 68: 1020, 69: 1035, 70: 1050,
            71: 1065, 72: 1080, 73: 1095, 74: 1110, 75: 1125, 76: 1140, 77: 1155, 78: 1170, 79: 1185, 80: 1200,
            81: 1215, 82: 1230, 83: 1245, 84: 1260, 85: 1275, 86: 1290, 87: 1305, 88: 1320, 89: 1335, 90: 1337,
            91: 1339, 92: 1339, 93: 1340, 94: 1344, 95: 1359, 96: 1373, 97: 1387, 98: 1392, 99: 1395, 100: 1400,
        };
        const CLASSIC_BULK_SHEET_RATE = 14.00;
        
        const VINYL_UNIT_RATE_TABLE = {
            1: 35, 2: 35, 3: 35, 4: 35, 5: 33, 6: 33, 7: 32, 8: 32, 9: 30, 10: 30,
            11: 29, 12: 29, 13: 28, 14: 28, 15: 27, 16: 27, 17: 27, 18: 26, 19: 26
        };
        const VINYL_BULK_RATE = 25;
        const VINYL_MATERIALS = ['vinyl_white', 'vinyl_clear'];
        const PLANILLA_MATERIALS = ['classic_glossy', ...VINYL_MATERIALS];

        // PRECIOS DTF UV
        const DTF_PRICE_TABLE = {
            10: 70, 11: 77, 12: 84, 13: 91, 14: 98, 15: 105, 16: 112, 17: 119, 18: 126, 19: 133,
            20: 135, 21: 137, 22: 137, 23: 138, 24: 138, 25: 140, 26: 145.6, 27: 151.2, 28: 156.8, 29: 162.4,
            30: 168, 31: 173.6, 32: 179.2, 33: 184.8, 34: 190.4, 35: 196, 36: 201.6, 37: 207.2, 38: 212.8, 39: 215,
            40: 215, 41: 215, 42: 215, 43: 217, 44: 217, 45: 217, 46: 217, 47: 219, 48: 219, 49: 219,
            50: 220, 51: 224.4, 52: 228.8, 53: 233.2, 54: 237.6, 55: 242, 56: 246.4, 57: 250.8, 58: 255.2, 59: 259.6,
            60: 264, 61: 268.4, 62: 272.8, 63: 277.2, 64: 281.6, 65: 286, 66: 290.4, 67: 294.8, 68: 299.2, 69: 303.6,
            70: 308, 71: 312.4, 72: 316.8, 73: 321.2, 74: 325.6, 75: 330, 76: 334.4, 77: 338.8, 78: 343.2, 79: 347.6,
            80: 352, 81: 356.4, 82: 360.8, 83: 365.2, 84: 369.6, 85: 374, 86: 378.4, 87: 382.8, 88: 385, 89: 385,
            90: 385, 91: 385, 92: 387, 93: 387, 94: 387, 95: 387, 96: 389, 97: 389, 98: 389, 99: 389
        };
        const DTF_RATE_100_299 = 3.9;
        const DTF_RATE_300_PLUS = 3.7;

        // Precios de Productos Fijos
        const MANTELITO_PRICING = {
            'carta': [
                { max: 19, price: 14 },
                { max: 49, price: 12 },
                { max: 99, price: 10 },
                { max: Infinity, price: 9 }
            ],
            'redondo': [
                { max: 19, price: 14 },
                { max: 49, price: 12 },
                { max: 99, price: 10 },
                { max: Infinity, price: 9 }
            ],
            'silueta': [
                { max: 19, price: 15 },
                { max: 49, price: 14 },
                { max: 99, price: 13 },
                { max: Infinity, price: 11 }
            ],
            'media_carta': [
                { max: 19, price: 12 },
                { max: 49, price: 10 },
                { max: 99, price: 9 },
                { max: Infinity, price: 7 }
            ]
        };

        // PRECIOS DE COMBOS
        const COMBO_PRICING = {
            'combo_cilindro_chupon': [
                { max: 24, price: 35 },
                { max: Infinity, price: 30 }
            ],
            'combo_cilindro_popote': [
                { max: 24, price: 37 },
                { max: Infinity, price: 30 }
            ],
            'combo_vaso_popote_16oz': [
                { max: 24, price: 50 },
                { max: Infinity, price: 45 }
            ],
            'combo_vaso_popote_24oz': [
                { max: 24, price: 65 },
                { max: Infinity, price: 55 }
            ],
            'combo_vaso_vip': [
                { max: 5, price: 145 },
                { max: Infinity, price: 130 }
            ]
        };

        // Planillas prediseñadas
        const predefinedSheets = {
            '3x3': { width: 3, height: 3, stickersPerSheet: 35 },
            '4x4': { width: 4, height: 4, stickersPerSheet: 24 },
            '4.5x4.5': { width: 4.5, height: 4.5, stickersPerSheet: 20 },
            '5x5': { width: 5, height: 5, stickersPerSheet: 12 },
            '5.5x5.5': { width: 5.5, height: 5.5, stickersPerSheet: 12 },
            '6x6': { width: 6, height: 6, stickersPerSheet: 12 },
            '7x7': { width: 7, height: 7, stickersPerSheet: 9 },
            '8x8': { width: 8, height: 8, stickersPerSheet: 6 }
        };
        
        // Tamaños de papel para rango completo
        const paperSizes = {
            'carta': { width: 21.59, height: 27.94 },
            'a4': { width: 21.0, height: 29.7 }
        };

        // Constantes de cálculo
        const DTF_FIXED_WIDTH_CM = 28;
        const DTF_SPACING_CM = 0.4;
        const CRICUT_USABLE_WIDTH_CM = 18;
        const CRICUT_USABLE_HEIGHT_CM = 26;
        const STICKER_SPACING_CM = 0.3;

        // NOMBRES CLAROS PARA LA LISTA DE PRODUCTOS
        const MATERIAL_NAMES = {
            'premium_dtf': 'IMPRESIÓN DTF UV',
            'classic_glossy': 'STICKER CLÁSICO',
            'vinyl_white': 'VINIL IMPRESO BLANCO',
            'vinyl_clear': 'VINIL IMPRESO TRANSPARENTE',
            'vaso': 'VASO PERSONALIZADO',
            'mantelito': 'MANTELITO/SOBREPLATO',
            'combo': 'COMBO VASO + MANTELITO'
        };

        const FIXED_PRODUCTS = ['vaso', 'mantelito', 'combo'];

        // VARIABLE GLOBAL PARA LA COTIZACIÓN ACTUAL
        let currentQuoteData = {
            material: 'premium_dtf',
            name: MATERIAL_NAMES['premium_dtf'],
            price: 0,
            quantity: 0,
            unit_type: 'CM',
            details: '',
            width: 0,
            height: 0,
            sticker_quantity: 0,
            personalization: ''
        };

        // FUNCIONES DE FORMATO
        function formatTotal(value) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            }).format(value);
        }

        function formatRate(value) {
             return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
            }).format(value);
        }

        // FUNCIONES PARA PLANILLAS PREDISEÑADAS Y RANGO COMPLETO
        function togglePredefinedSheets() {
            const predefinedCheckbox = document.getElementById('predefined-sheet');
            const fullRangeCheckbox = document.getElementById('full-range');
            const predefinedContainer = document.getElementById('predefined-sheets-container');
            const fullRangeContainer = document.getElementById('full-range-container');
            
            if (predefinedCheckbox.checked) {
                predefinedContainer.classList.remove('hidden');
                if (fullRangeCheckbox.checked) {
                    fullRangeCheckbox.checked = false;
                    fullRangeContainer.classList.add('hidden');
                }
                if (document.getElementById('predefined-sheets').value === "") {
                    document.getElementById('predefined-sheets').value = '3x3';
                    applyPredefinedSheet();
                } else {
                    applyPredefinedSheet();
                }
            } else {
                predefinedContainer.classList.add('hidden');
                calculateAreaPrice();
            }
        }
        
        function toggleFullRange() {
            const predefinedCheckbox = document.getElementById('predefined-sheet');
            const fullRangeCheckbox = document.getElementById('full-range');
            const predefinedContainer = document.getElementById('predefined-sheets-container');
            const fullRangeContainer = document.getElementById('full-range-container');
            
            if (fullRangeCheckbox.checked) {
                fullRangeContainer.classList.remove('hidden');
                if (predefinedCheckbox.checked) {
                    predefinedCheckbox.checked = false;
                    predefinedContainer.classList.add('hidden');
                }
                calculateFullRange();
            } else {
                fullRangeContainer.classList.add('hidden');
                calculateAreaPrice();
            }
        }
        
        function applyPredefinedSheet() {
            const selectedSheet = document.getElementById('predefined-sheets').value;
            
            if (selectedSheet && predefinedSheets[selectedSheet]) {
                const sheet = predefinedSheets[selectedSheet];
                document.getElementById('width').value = sheet.width;
                document.getElementById('height').value = sheet.height;
                document.getElementById('fit-per-sheet').textContent = sheet.stickersPerSheet;
                
                const quantity = parseInt(document.getElementById('quantity').value) || 0;
                const sheetsNeeded = Math.ceil(quantity / sheet.stickersPerSheet);
                document.getElementById('sheets-needed').textContent = sheetsNeeded;
                
                const material = document.getElementById('material').value;
                calculateAreaPriceWithSheets(sheetsNeeded, material);
            }
        }
        
        function calculateFullRange() {
            const paperSize = document.getElementById('paper-size').value;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            
            if (width <= 0 || height <= 0) return;
            
            const paper = paperSizes[paperSize];
            const fitWidth = Math.floor(paper.width / width);
            const fitHeight = Math.floor(paper.height / height);
            const fitPerSheet = fitWidth * fitHeight;
            
            document.getElementById('fit-per-sheet').textContent = fitPerSheet;
            
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const sheetsNeeded = Math.ceil(quantity / fitPerSheet);
            document.getElementById('sheets-needed').textContent = sheetsNeeded;
            
            const material = document.getElementById('material').value;
            calculateAreaPriceWithSheets(sheetsNeeded, material);
        }
        
        function calculateManualSheets() {
            const manualSheets = parseInt(document.getElementById('manual-sheets').value) || 0;
            const material = document.getElementById('material').value;
            
            if (manualSheets > 0) {
                calculateAreaPriceWithSheets(manualSheets, material);
            } else {
                calculateAreaPrice();
            }
        }

        // LÓGICA DE CÁLCULO DTF
        function calculateDtfLength() {
            const quantity = parseFloat(document.getElementById('quantity_dtf').value) || 0;
            const width = parseFloat(document.getElementById('width_dtf').value) || 0;
            const height = parseFloat(document.getElementById('height_dtf').value) || 0;
            const resultElement = document.getElementById('calculated_length');

            if (quantity <= 0 || width <= 0 || height <= 0) {
                resultElement.textContent = '0 CM';
                return 0;
            }

            const w_effective = width + DTF_SPACING_CM;
            const h_effective = height + DTF_SPACING_CM;

            const fit_per_row_1 = Math.floor(DTF_FIXED_WIDTH_CM / w_effective);
            let total_length_1 = Infinity;
            if (fit_per_row_1 > 0) {
                const rows_needed_1 = Math.ceil(quantity / fit_per_row_1);
                total_length_1 = rows_needed_1 * h_effective;
            }

            const fit_per_row_2 = Math.floor(DTF_FIXED_WIDTH_CM / h_effective);
            let total_length_2 = Infinity;
            if (fit_per_row_2 > 0) {
                const rows_needed_2 = Math.ceil(quantity / fit_per_row_2);
                total_length_2 = rows_needed_2 * w_effective;
            }
            
            const finalLength = Math.min(total_length_1, total_length_2);

            if (finalLength === Infinity || finalLength === 0) {
                resultElement.textContent = 'ERROR (Muy grandes)';
                return 0;
            }

            const roundedLength = Math.ceil(finalLength);
            resultElement.textContent = `${roundedLength.toFixed(0)} CM`;
            
            return roundedLength;
        }

        window.calculateDtfPrice = function() {
            const material = document.getElementById('material').value;
            const totalElement = document.getElementById('dtf-total-price');
            const unitPriceElement = document.getElementById('dtf-unit-price');
            const addButton = document.getElementById('add-to-list-dtf');
            
            let printedLength = parseFloat(document.getElementById('printed_length_direct').value) || 0;
            
            let totalPrice = 0;
            let effectiveRate = 0;
            
            const warningId = 'min-price-warning';
            const existingWarning = document.getElementById(warningId);
            if (existingWarning) existingWarning.remove();
            
            if (printedLength <= 0) {
                 totalElement.textContent = formatTotal(0);
                 unitPriceElement.textContent = formatRate(0);
                 addButton.disabled = true;
                 return;
            }

            if (printedLength < MIN_DTF_LENGTH) {
                totalElement.textContent = formatTotal(0);
                unitPriceElement.textContent = formatRate(0);
                addButton.disabled = true;
                
                document.getElementById('length-inputs').querySelector('.space-y-2').insertAdjacentHTML('beforeend',
                    `<p id="${warningId}" class="text-sm text-primary font-bold mt-2">⚠️ Largo mínimo de impresión es de 10 cm ($${DTF_PRICE_TABLE[10]}.00 MXN).</p>`
                );
                return;
            }
            
            const lengthForPricing = Math.ceil(printedLength);
            
            if (lengthForPricing <= 0) {
                totalPrice = 0;
            } else if (lengthForPricing in DTF_PRICE_TABLE) {
                totalPrice = DTF_PRICE_TABLE[lengthForPricing];
                effectiveRate = totalPrice / lengthForPricing;
            } else if (lengthForPricing >= 100 && lengthForPricing < 300) {
                totalPrice = lengthForPricing * DTF_RATE_100_299;
                effectiveRate = DTF_RATE_100_299;
            } else if (lengthForPricing >= 300) {
                totalPrice = lengthForPricing * DTF_RATE_300_PLUS;
                effectiveRate = DTF_RATE_300_PLUS;
            }

            totalElement.textContent = formatTotal(totalPrice);
            unitPriceElement.textContent = formatRate(effectiveRate);
            
            // ACTUALIZAR currentQuoteData CORRECTAMENTE
            currentQuoteData = {
                material: material,
                name: 'IMPRESIÓN DTF UV',
                price: totalPrice,
                quantity: lengthForPricing,
                unit_type: 'CM',
                details: `${lengthForPricing.toFixed(0)} CM @ ${formatRate(effectiveRate)}/cm`,
                width: parseFloat(document.getElementById('width_dtf').value) || 0,
                height: parseFloat(document.getElementById('height_dtf').value) || 0,
                sticker_quantity: parseFloat(document.getElementById('quantity_dtf').value) || 0,
                personalization: ''
            };
            
            addButton.disabled = totalPrice <= 0;
        }

        // FUNCIONES AUXILIARES PARA PRECIOS
        function getVasoPriceByQuantity(vasoKey, quantity) {
            const pricing = {
                'cilindro_chupon': [
                    { max: 29, price: 19.00 },
                    { max: 49, price: 18.50 },
                    { max: 99, price: 18.00 },
                    { max: Infinity, price: 17.50 }
                ],
                'cilindro_popote': [
                    { max: 29, price: 23.00 },
                    { max: 49, price: 22.50 },
                    { max: 99, price: 22.00 },
                    { max: Infinity, price: 21.00 }
                ],
                'vaso_popote_16oz': [
                    { max: 29, price: 35.00 },
                    { max: 49, price: 33.00 },
                    { max: 99, price: 30.00 },
                    { max: Infinity, price: 28.00 }
                ],
                'vaso_popote_24oz': [
                    { max: 29, price: 50.00 },
                    { max: 49, price: 45.00 },
                    { max: 99, price: 42.00 },
                    { max: Infinity, price: 40.00 }
                ],
                'vaso_vip': [
                    { max: 5, price: 130.00 },
                    { max: 10, price: 120.00 },
                    { max: Infinity, price: 110.00 }
                ]
            };

            const tiers = pricing[vasoKey] || [];
            if (quantity <= 0) return 0;
            
            for (const tier of tiers) {
                if (quantity <= tier.max) {
                    return tier.price;
                }
            }
            return 0;
        }

        function getMantelitoPrice(mantelitoKey, quantity) {
            const pricingTiers = MANTELITO_PRICING[mantelitoKey];
            if (!pricingTiers || quantity <= 0) return 0;
            
            for (const tier of pricingTiers) {
                if (quantity <= tier.max) {
                    return tier.price;
                }
            }
            return 0;
        }

        function getComboPrice(comboKey, quantity) {
            const pricingTiers = COMBO_PRICING[comboKey];
            if (!pricingTiers || quantity <= 0) return 0;
            
            for (const tier of pricingTiers) {
                if (quantity <= tier.max) {
                    return tier.price;
                }
            }
            return 0;
        }

        // FUNCIÓN DE CÁLCULO DE ÁREA
        function calculateFitPerSheet(width, height) {
            if (width <= 0 || height <= 0) return 0;

            const w_prime = width + STICKER_SPACING_CM;
            const h_prime = height + STICKER_SPACING_CM;

            const fit1_rows = Math.floor(CRICUT_USABLE_WIDTH_CM / w_prime);
            const fit1_cols = Math.floor(CRICUT_USABLE_HEIGHT_CM / h_prime);
            const fit1 = fit1_rows * fit1_cols;

            const fit2_rows = Math.floor(CRICUT_USABLE_WIDTH_CM / h_prime);
            const fit2_cols = Math.floor(CRICUT_USABLE_HEIGHT_CM / w_prime);
            const fit2 = fit2_rows * fit2_cols;
            
            return Math.max(fit1, fit2);
        }

        function getTotalPriceForSheets(totalSheets, material) {
            if (totalSheets <= 0) return 0;
            
            if (material === 'classic_glossy') {
                if (totalSheets in CLASSIC_GLOSSY_PRICING_MAP) {
                    return CLASSIC_GLOSSY_PRICING_MAP[totalSheets];
                }
                if (totalSheets > 100) {
                    return totalSheets * CLASSIC_BULK_SHEET_RATE;
                }
            }
            
            const isVinyl = VINYL_MATERIALS.includes(material);
            if (isVinyl) {
                if (totalSheets >= 20) {
                    return totalSheets * VINYL_BULK_RATE;
                }
                const pricePerSheet = VINYL_UNIT_RATE_TABLE[totalSheets];
                if (pricePerSheet) {
                    return totalSheets * pricePerSheet;
                }
                if (totalSheets >= 1) {
                     const rate19 = VINYL_UNIT_RATE_TABLE[19] || VINYL_BULK_RATE;
                     return totalSheets * (VINYL_UNIT_RATE_TABLE[totalSheets] || rate19);
                }
            }
            
            return 0;
        }

        function calculateAreaPriceWithSheets(sheetsToUse, material) {
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            
            let fitPerSheet;
            const predefinedSheetSelected = document.getElementById('predefined-sheet').checked;
            const fullRangeSelected = document.getElementById('full-range').checked;
            
            if (predefinedSheetSelected) {
                const selectedSheet = document.getElementById('predefined-sheets').value;
                if (selectedSheet && predefinedSheets[selectedSheet]) {
                    fitPerSheet = predefinedSheets[selectedSheet].stickersPerSheet;
                } else {
                    fitPerSheet = calculateFitPerSheet(width, height);
                }
            } else if (fullRangeSelected) {
                const paperSize = document.getElementById('paper-size').value;
                const paper = paperSizes[paperSize];
                const fitWidth = Math.floor(paper.width / width);
                const fitHeight = Math.floor(paper.height / height);
                fitPerSheet = fitWidth * fitHeight;
            } else {
                fitPerSheet = calculateFitPerSheet(width, height);
            }
            
            const totalPrice = getTotalPriceForSheets(sheetsToUse, material);
            const unitPrice = sheetsToUse > 0 ? totalPrice / sheetsToUse : 0;
            
            document.getElementById('fit-per-sheet').textContent = fitPerSheet;
            document.getElementById('sheets-needed').textContent = sheetsToUse;
            document.getElementById('area-total-price').textContent = formatTotal(totalPrice);
            document.getElementById('area-unit-price').textContent = formatRate(unitPrice);
            
            // ACTUALIZAR currentQuoteData CORRECTAMENTE
            currentQuoteData = {
                material: material,
                name: MATERIAL_NAMES[material],
                price: totalPrice,
                quantity: sheetsToUse,
                unit_type: 'PLANILLA',
                details: `${width}x${height}cm (${quantity} stickers)`,
                unit_price: unitPrice,
                width: width,
                height: height,
                sticker_quantity: quantity,
                fit_per_sheet: fitPerSheet,
                personalization: ''
            };
            
            document.getElementById('add-to-list-area').disabled = totalPrice <= 0;
        }

        window.calculateAreaPrice = function() {
            const material = document.getElementById('material').value;
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            const manualSheets = parseInt(document.getElementById('manual-sheets').value) || 0;
            
            let fitPerSheet;
            let sheetsNeeded;
            
            const predefinedSheetSelected = document.getElementById('predefined-sheet').checked;
            const fullRangeSelected = document.getElementById('full-range').checked;
            
            if (predefinedSheetSelected) {
                const selectedSheet = document.getElementById('predefined-sheets').value;
                if (selectedSheet && predefinedSheets[selectedSheet]) {
                    fitPerSheet = predefinedSheets[selectedSheet].stickersPerSheet;
                    sheetsNeeded = Math.ceil(quantity / fitPerSheet);
                } else {
                    fitPerSheet = calculateFitPerSheet(width, height);
                    sheetsNeeded = Math.ceil(quantity / fitPerSheet);
                }
            } else if (fullRangeSelected) {
                const paperSize = document.getElementById('paper-size').value;
                const paper = paperSizes[paperSize];
                const fitWidth = Math.floor(paper.width / width);
                const fitHeight = Math.floor(paper.height / height);
                fitPerSheet = fitWidth * fitHeight;
                sheetsNeeded = Math.ceil(quantity / fitPerSheet);
            } else {
                fitPerSheet = calculateFitPerSheet(width, height);
                sheetsNeeded = Math.ceil(quantity / fitPerSheet);
            }
            
            if (fitPerSheet === 0) {
                document.getElementById('fit-per-sheet').textContent = "¡Demasiado grande!";
                document.getElementById('sheets-needed').textContent = "-";
                document.getElementById('area-total-price').textContent = formatTotal(0);
                document.getElementById('area-unit-price').textContent = formatRate(0);
                document.getElementById('add-to-list-area').disabled = true;
                return;
            }
            
            const sheetsToUse = manualSheets > 0 ? manualSheets : sheetsNeeded;
            
            calculateAreaPriceWithSheets(sheetsToUse, material);
        }

        // LÓGICA DE PRODUCTOS FIJOS
        function populateFixedProductSelect(material, selectElement) {
            selectElement.innerHTML = '';
            let options = [];

            if (material === 'vaso') {
                document.querySelector('#vaso-type-container label').textContent = 'TIPO DE VASO';
                options = [
                    { value: "cilindro_chupon", text: "CILINDRO CHUPÓN" },
                    { value: "cilindro_popote", text: "CILINDRO POPOTE" },
                    { value: "vaso_popote_16oz", text: "VASO POPOTE 16 OZ" },
                    { value: "vaso_popote_24oz", text: "VASO POPOTE 24 OZ" },
                    { value: "vaso_vip", text: "VASO VIP (CRISTAL POPOTE)" }
                ];
            } else if (material === 'combo') {
                document.querySelector('#vaso-type-container label').textContent = 'TIPO DE COMBO';
                options = [
                    { value: "combo_cilindro_chupon", text: "COMBO CILINDRO CHUPÓN" },
                    { value: "combo_cilindro_popote", text: "COMBO CILINDRO POPOTE" },
                    { value: "combo_vaso_popote_16oz", text: "COMBO VASO POPOTE 16 OZ" },
                    { value: "combo_vaso_popote_24oz", text: "COMBO VASO POPOTE 24 OZ" },
                    { value: "combo_vaso_vip", text: "COMBO VASO VIP (CRISTAL POPOTE)" }
                ];
            }

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                selectElement.appendChild(option);
            });
        }

        window.calculateFixedPrice = function() {
            const material = document.getElementById('material').value;
            const vasoSelect = document.getElementById('select-vaso');
            const mantelitoSelect = document.getElementById('select-mantelito');
            const personalizationInput = document.getElementById('personalization_details');

            const selectedType = (material === 'mantelito') ? mantelitoSelect.value : vasoSelect.value;
            const quantityInput = document.getElementById('quantity_product').value;
            const addButton = document.getElementById('add-to-list-product');

            const totalElement = document.getElementById('product-total-price');
            const unitPriceElement = document.getElementById('product-unit-price');

            const quantity = parseInt(quantityInput) || 0;
            const personalization = personalizationInput ? personalizationInput.value.trim() : '';
            
            let unitPrice = 0;
            let itemName = 'PRODUCTO DESCONOCIDO';
            let unitType = 'UNIDAD';

            if (quantity <= 0) {
                 totalElement.textContent = formatTotal(0);
                 unitPriceElement.textContent = formatRate(0);
                 addButton.disabled = true;
                 return;
            }

            if (material === 'mantelito') {
                unitPrice = getMantelitoPrice(selectedType, quantity);
                itemName = `MANTELITO ${selectedType.toUpperCase()}`;
                unitType = 'UNIDAD';
            } else if (material === 'vaso') {
                unitPrice = getVasoPriceByQuantity(selectedType, quantity);
                itemName = `VASO ${selectedType.split('_')[1].toUpperCase()}`;
                unitType = 'UNIDAD';
            } else if (material === 'combo') {
                unitPrice = getComboPrice(selectedType, quantity);
                itemName = `COMBO ${selectedType.split('_')[1].toUpperCase()}`;
                unitType = 'COMBO';
            }
            
            if (unitPrice <= 0) {
                totalElement.textContent = formatTotal(0);
                unitPriceElement.textContent = formatRate(0);
                addButton.disabled = true;
                return;
            }

            const totalPrice = quantity * unitPrice;

            totalElement.textContent = formatTotal(totalPrice);
            unitPriceElement.textContent = formatRate(unitPrice);

            // ACTUALIZAR currentQuoteData CORRECTAMENTE
            currentQuoteData = {
                material: material,
                name: itemName,
                price: totalPrice,
                quantity: quantity,
                unit_type: unitType,
                details: `Total: ${formatRate(totalPrice)} (${formatRate(unitPrice)} c/u)`,
                unit_price: unitPrice,
                personalization: personalization
            };

            addButton.disabled = totalPrice <= 0;
        }
        
        // FUNCIÓN PRINCIPAL DE COTIZACIÓN
        window.calculateQuote = function() {
            const material = document.getElementById('material').value;
            const isDtfPremium = (material === 'premium_dtf');
            const isPlanilla = PLANILLA_MATERIALS.includes(material);
            const isFixedProduct = FIXED_PRODUCTS.includes(material);
            
            const vasoTypeContainer = document.getElementById('vaso-type-container');
            const vasoSelect = document.getElementById('select-vaso');
            const mantelitoTypeContainer = document.getElementById('mantelito-type-container');
            const personalizationContainer = document.getElementById('personalization-container');

            // Ocultar todas las interfaces primero
            document.getElementById('dtf-interface').classList.add('hidden');
            document.getElementById('area-inputs').classList.add('hidden');
            document.getElementById('product-inputs').classList.add('hidden');
            vasoTypeContainer.classList.add('hidden');
            mantelitoTypeContainer.classList.add('hidden');
            personalizationContainer.classList.add('hidden');
            
            // Lógica de DTF
            if (isDtfPremium) {
                document.getElementById('dtf-interface').classList.remove('hidden');
                
                const calculatedLength = calculateDtfLength();
                
                const directInput = document.getElementById('printed_length_direct');
                
                if (calculatedLength > 0 && calculatedLength !== parseFloat(directInput.value)) {
                     directInput.value = calculatedLength;
                } else if (parseFloat(directInput.value) < MIN_DTF_LENGTH) {
                   directInput.value = MIN_DTF_LENGTH;
                }
                
                calculateDtfPrice();

            // Lógica de Planillas
            } else if (isPlanilla) {
                document.getElementById('area-inputs').classList.remove('hidden');
                calculateAreaPrice();
            
            // Lógica de Productos Fijos
            } else if (isFixedProduct) {
                document.getElementById('product-inputs').classList.remove('hidden');
                personalizationContainer.classList.remove('hidden');
                
                if (material === 'vaso' || material === 'combo') {
                    vasoTypeContainer.classList.remove('hidden');
                    populateFixedProductSelect(material, vasoSelect);
                } else if (material === 'mantelito') {
                    mantelitoTypeContainer.classList.remove('hidden');
                }
                
                calculateFixedPrice();
            }
        }

        // FUNCIONES PARA LA LISTA DE COTIZACIONES - CORREGIDAS
        window.addCurrentQuoteToList = function() {
            console.log('Función addCurrentQuoteToList llamada');
            console.log('currentQuoteData:', currentQuoteData);
            
            if (currentQuoteData && currentQuoteData.price > 0) {
                const itemToAdd = { 
                    ...currentQuoteData, 
                    id: Date.now() + Math.random() 
                };
                quoteList.push(itemToAdd);
                updateQuoteListUI();
                updateFinalTotal();
                
                // Animación de confirmación
                let addButtonId = '';
                const material = document.getElementById('material').value;

                if (material === 'premium_dtf') {
                    addButtonId = 'add-to-list-dtf';
                } else if (PLANILLA_MATERIALS.includes(material)) {
                    addButtonId = 'add-to-list-area';
                } else if (FIXED_PRODUCTS.includes(material)) {
                    addButtonId = 'add-to-list-product';
                }

                const addButton = document.getElementById(addButtonId);
                if (addButton) {
                    addButton.textContent = '¡AÑADIDO!';
                    addButton.classList.add('bg-secondary', 'text-text-dark', 'pulse-secondary-animation');
                    addButton.classList.remove('bg-primary', 'text-text-light');
                    setTimeout(() => {
                        addButton.textContent = 'AÑADIR A LA LISTA';
                        addButton.classList.remove('bg-secondary', 'text-text-dark', 'pulse-secondary-animation');
                        addButton.classList.add('bg-primary', 'text-text-light');
                    }, 1500);
                }

                console.log('Producto añadido a la lista:', itemToAdd);
                console.log('Lista actual:', quoteList);
            } else {
                console.warn("No se puede añadir a la lista, el precio es cero o currentQuoteData no está definido.");
                alert('Por favor, calcula un precio válido antes de añadir a la lista.');
            }
        }

        function updateQuoteListUI() {
            const listContainer = document.getElementById('quote-list');
            const emptyMessage = document.getElementById('empty-list-message');
            
            // Limpiar lista
            listContainer.innerHTML = '';
            
            if (quoteList.length === 0) {
                // Mostrar mensaje de lista vacía
                listContainer.appendChild(emptyMessage);
                emptyMessage.classList.remove('hidden');
                return;
            }
            
            // Ocultar mensaje de lista vacía
            emptyMessage.classList.add('hidden');
            
            // Agregar cada elemento de la lista
            quoteList.forEach((quote, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'flex justify-between items-center bg-white p-2 sm:p-3 rounded-lg border border-gray-300';
                
                listItem.innerHTML = `
                    <div class="flex-1">
                        <div class="font-semibold text-text-dark text-sm sm:text-base">${quote.name}</div>
                        <div class="text-xs text-text-dark/70">${quote.details}</div>
                        ${quote.personalization ? `<div class="text-xs text-primary font-semibold mt-1">${quote.personalization}</div>` : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-extrabold text-primary text-base sm:text-lg">${formatTotal(quote.price)}</span>
                        <button onclick="removeFromList(${index})" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(listItem);
            });
        }

        function removeFromList(index) {
            quoteList.splice(index, 1);
            updateQuoteListUI();
            updateFinalTotal();
        }

        function updateFinalTotal() {
            const total = quoteList.reduce((sum, quote) => sum + quote.price, 0);
            document.getElementById('final-total').textContent = formatTotal(total);
            document.getElementById('generate-ticket-btn').disabled = quoteList.length === 0;
        }

        // GENERADOR DE TICKET
        function generateTicket() {
            if (quoteList.length === 0) {
                alert('No hay productos en la lista para generar un ticket.');
                return;
            }
            
            const ticketPreview = document.getElementById('ticket-preview');
            const total = quoteList.reduce((sum, quote) => sum + quote.price, 0);
            const today = new Date();
            const dateString = today.toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            let ticketHTML = `
                <div class="ticket-header">
                    <img src="https://www.dropbox.com/scl/fi/xpobzj48hrvwrggk9w2iz/INSTAGRAM.png?rlkey=zcxxkd3uuj27nlbsiccynl6ju&st=cj2dj0xl&dl=1" 
                         alt="Logo de Algo Special" 
                         class="ticket-logo">
                    <div class="ticket-title">ALGO SPECIAL</div>
                    <div class="ticket-subtitle">Transforma cada momento en una experiencia extraordinaria</div>
                    <div style="font-size: 12px; margin-top: 5px; color: #666;">COTIZACIÓN - ${dateString}</div>
                </div>
            `;
            
            quoteList.forEach((quote, index) => {
                ticketHTML += `
                    <div class="ticket-item">
                        <div>
                            <span>${quote.name}</span>
                            <div style="font-size: 11px; color: #666; margin-top: 2px;">${quote.details}</div>
                            ${quote.personalization ? `<div style="font-size: 10px; color: #FF1F9F; margin-top: 2px;">${quote.personalization}</div>` : ''}
                        </div>
                        <span>${formatTotal(quote.price)}</span>
                    </div>
                `;
            });
            
            ticketHTML += `
                <div class="ticket-total">
                    <span>TOTAL</span>
                    <span>${formatTotal(total)}</span>
                </div>
                <div class="ticket-footer">
                    <p>¡Gracias por tu preferencia!</p>
                    <p>Cotización válida por 7 días</p>
                    <p>www.algospecial.com</p>
                </div>
            `;
            
            ticketPreview.innerHTML = ticketHTML;
            document.getElementById('ticket-container').classList.remove('hidden');
        }
        
        function closeTicketPreview() {
            document.getElementById('ticket-container').classList.add('hidden');
        }
        
        function downloadTicket() {
            const ticketElement = document.getElementById('ticket-preview');
            
            html2canvas(ticketElement, {
                scale: 2,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `cotizacion-algo-special-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                closeTicketPreview();
            });
        }

        // INICIALIZACIÓN
        window.addEventListener('load', () => {
            console.log('Página cargada, inicializando cotizador...');
            window.calculateQuote();
        });
    </script>
</body>
</html>
